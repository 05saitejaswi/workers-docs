name = "A/B Testing"
description = "A/B test responses from the edge"
code = '''
// This worker doesn't work as intended in the previewer because the previewer assigns a new cookie every request
// Assigned groups will stay the same in production
async function handleRequest(request) {
  /**
   * The responses you want to send per group. Responses cannot be created in the global scope
   * @param {Request} testResponse
   * @param {Request} controlResponse
   */
  const testResponse = new Response('Test group')
  const controlResponse = new Response('Control group')
  let group = Math.random() < 0.5 ? 'test' : 'control'
  let isNew = false
  let response
  const cookie = request.headers.get('cookie')
  if (cookie && cookie.includes('group=control')) {
    group = 'control'
  } else if (cookie && cookie.includes('group=test')) {
    group = 'test'
  } else {
    isNew = true
  }
  if (group === 'test') {
    response = testResponse
  } else if (group === 'control') {
    response = controlResponse
  }
  if (isNew) {
    response.headers.append('Set-Cookie', `group=${group}; path=/`)
  }
  return response
}
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})
'''